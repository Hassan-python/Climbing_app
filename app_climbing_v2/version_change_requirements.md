# ボルダリング動画分析API バージョンアップ要件定義書

## 1. 背景・目的

既存のボルダリング動画分析API (`app_backup_v1.py`) は、動画フレームの分析処理にGoogle Gemini APIを、関連知識の検索と最終的なアドバイス生成にOpenAI APIおよびChromaDBを利用している。
この構成は複数のLLM API呼び出しを伴い、処理フローが分断されている。

本バージョンアップ (`main.py`) の主な目的は以下の通りである。

1.  **API呼び出しの効率化**: 分析とアドバイス生成をGoogle Gemini APIの1回の呼び出しに集約することで、処理のレイテンシ削減とコスト効率の改善を目指す。
2.  **RAG (Retrieval Augmented Generation) の統合**: Gemini APIの呼び出し時に、ChromaDBから取得した関連知識をコンテキストとして含めることで、より精度の高い、状況に応じたアドバイス生成を実現する。
3.  **技術スタックの統一**:可能な限りGoogle CloudのAI技術 (Gemini API, Gemini Embeddings) に寄せることで、依存関係をシンプルにし、管理コストを低減する。

## 2. スコープ

本バージョンアップでは、以下の機能を変更・実装する。

-   動画分析とアドバイス生成処理を、単一のGemini API呼び出しに統合する。
-   Gemini API呼び出し時に、ChromaDBから取得した関連情報をコンテキストとして渡し、RAGを実現する。
-   ベクトル検索に使用するEmbeddingモデルを、OpenAI EmbeddingsからGoogle Gemini Embeddings (`models/embedding-001`) に変更する。
-   上記変更に伴い、OpenAI APIへの依存を排除する。

以下の機能・仕様は現行バージョンから変更しない（スコープ外）。

-   FastAPIアプリケーションの基本的な構造（エンドポイントURL、リクエスト/レスポンスモデルの主要なフィールド）
-   動画アップロード機能（GCS連携、ファイルサイズ・時間制限）
-   フレーム抽出ロジック
-   ChromaDBの利用（コレクション名、クライアント接続方法の基本）
-   多言語対応の基本的な仕組み（`X-Language` ヘッダーによる言語切り替え）
-   エラーハンドリングの基本的な方針
-   CORS設定
-   既存の環境変数（`GCS_BUCKET_NAME`, `CHROMA_DB_URL`, `GEMINI_API_KEY` 等。ただし `OPENAI_API_KEY`, `OPENAI_MODEL_NAME` は不要となる）

## 3. 機能要件

### 3.1. 動画分析・アドバイス生成処理の統合 (FR-001)

-   **要件ID**: FR-001
-   **説明**: ユーザーから受け取った動画フレーム、課題の種類、難しい点、およびChromaDBから取得した関連知識（FR-002で定義）を基に、1回のGemini API呼び出しで「画像分析結果」と「具体的なアドバイス」を生成する。
-   **詳細**:
    -   Gemini API (例: `gemini-2.0-flash-lite`) を使用する。
    -   **プロンプト構成:**
        1.  **役割設定**: 「あなたはクライミングの動きを分析する専門家であり、経験豊富なプロのボルダリングコーチです。」
        2.  **タスク指示1 (画像分析)**: 提供された画像に基づき、クライマーの体勢、バランス、手足の位置と動き、非効率な動きや不安定要素を客観的に記述するよう指示。
        3.  **タスク指示2 (アドバイス生成)**: 上記の画像分析結果、ユーザーが報告した状況、および後述する「関連するボルダリング知識」を**総合的に考慮し、特に提供された知識を優先的に活用して**、具体的かつ実践的な改善アドバイスを生成するよう指示。アドバイスはステップ形式（例：3ステップ）を推奨。
        4.  **ユーザー報告情報**: `課題の種類`、`難しいと感じるポイント` を明示。
        5.  **関連知識の提示**: FR-002で取得した知識を、明確なセクション（例: `### 関連するボルダリング知識 (データベースより参考情報)`) として提示し、各知識源が区別できるようにする（例: `[知識1] コンテンツ内容`, `[知識2] コンテンツ内容`）。
        6.  **出力形式指示**: 回答を「# 画像分析」と「# アドバイス」の2つのセクションに分けて出力するよう厳密に指示。
        7.  **言語指示**: レスポンスの言語は、リクエストヘッダー `X-Language` に基づいて指定する。
    -   プロンプトにChromaDBから取得した関連知識を明示的に含める際には、その情報が検索結果であることを明確にし、アドバイス生成時の主要な参考情報として扱うようGeminiに指示する。

### 3.2. RAG (Retrieval Augmented Generation) の実装 (FR-002)

-   **要件ID**: FR-002
-   **説明**: ユーザーが入力した「課題の種類」と「難しい点」を主軸として検索クエリを構築し、ChromaDBから関連性の高いボルダリング知識を検索し、Gemini APIのプロンプトに含める。
-   **詳細**:
    -   **検索クエリ生成**:
        -   基本クエリ: ユーザー入力の `problemType`（課題の種類）と `crux`（難しい点）を主要な情報とする。これらの情報が不足している場合や曖昧な場合は、汎用的なキーワードで補完することも検討する。
        -   （検討事項）旧バージョンではGeminiの画像分析結果のテキストをクエリに付加していた。Geminiの1回呼び出し制約下でこれを再現するのは困難なため、ユーザー入力の質を高めるか、プロンプトエンジニアリングでGemini自身に画像情報とユーザー入力を関連付けて知識検索の必要性を判断させることを目指す。
    -   **Embeddingモデル**: ベクトル検索には `GoogleGenerativeAiEmbeddings` (例: `models/embedding-001`) を使用する。ChromaDB内の既存データも同等または互換性のあるEmbeddingモデルで生成されていることを**保証する**（必要であればデータ再生成もスコープに含める）。
    -   **検索実行**: Langchainの `Chroma` ベクターストア連携機能を利用し、類似度検索 (`similarity_search`) を行う。
    -   **結果の選定**: 検索結果の件数 (例: `k=3` から `k=5` の間で調整可能とし、最適な件数を見極める。初期値は `k=3` とする) や類似度スコアの閾値（設定可能な場合）を導入し、ノイズとなる情報の混入を低減し、関連性の高い情報を厳選する。
    -   **プロンプトへの統合**: 取得したドキュメントの内容 (`page_content`) およびメタデータから取得できるソース名（例: `doc.metadata.get("name")`）を、FR-001で定義されたプロンプトの指定箇所に、各情報源が区別できる形で埋め込む。
    -   **デバッグ容易性**: 検索に使用した最終的なクエリ文字列、取得したドキュメントのメタデータ（ソース名、IDなど）および類似度スコア（取得可能な場合）をログに出力し、RAGプロセスの検証を容易にする。

### 3.3. OpenAI API依存の排除 (FR-003)

-   **要件ID**: FR-003
-   **説明**: 従来のOpenAI EmbeddingsおよびOpenAI Chatモデルへの依存を完全に排除する。
-   **詳細**:
    -   `langchain-openai` ライブラリの関連コード（`OpenAIEmbeddings`, `ChatOpenAI`）を削除する。
    -   環境変数 `OPENAI_API_KEY`, `OPENAI_MODEL_NAME` の参照を削除する。

## 4. 非機能要件

### 4.1. パフォーマンス (NFR-001)

-   **要件ID**: NFR-001
    -   **説明**: API呼び出し回数の削減により、`/analyze` エンドポイントの平均レスポンスタイムが旧バージョンと比較して同等以下であることを目指す。
        ただし、Gemini API単体での処理時間が支配的になる可能性があるため、大幅な速度向上を必須とはしない。
    -   **補足**: `@lru_cache` など、適切なキャッシュ機構の利用を検討し、不要な再計算を避けることでパフォーマンスを維持する。（例：ChromaDBクライアント取得、Embeddingモデルインスタンス取得など）

### 4.2. 保守性 (NFR-002)

-   **要件ID**: NFR-002
-   **説明**: コードの可読性を維持し、単一責任の原則に配慮した関数設計を心がける。主要なロジックの変更点については、コメントやドキュメント文字列で意図を明確にする。

### 4.3. 互換性 (NFR-003)

-   **要件ID**: NFR-003
-   **説明**: `/upload` および `/analyze` エンドポイントのリクエスト/レスポンスのスキーマ（主要なフィールド名と型）は、旧バージョンとの後方互換性を維持する。これにより、既存のクライアントアプリケーションへの影響を最小限に抑える。
    -   `AnalysisResponse` モデルの `sources` フィールドの内容（ドキュメント名とコンテント）は、RAGで利用した情報源を示すように適切に更新される。

## 5. 変更点以外で完全に一致させるべき点

以下の要素は、明示的な変更要件がない限り、旧バージョン (`app_backup_v1.py`) と新バージョン (`main.py`) で完全に一致させることを目指す。

1.  **エラーハンドリング**: HTTPステータスコード、エラーメッセージ形式など。
2.  **動画処理ロジック**: `extract_frames` 関数の動作、一時ファイルの扱い（作成と削除）。
3.  **GCS連携**: アップロード処理、Blob名の生成、エラー時のクリーンアップ。
4.  **定数**: `ANALYSIS_INTERVAL_SEC`, `MAX_FRAMES_FOR_GEMINI`, `CHROMA_COLLECTION_NAME` など、明示的な変更指示がないもの。
5.  **FastAPI設定**: CORS設定、アプリケーションインスタンスの初期化。
6.  **基本的な関数の動作**: `get_chroma_client` の基本的な接続ロジック（ただし、Langchainラッパーの利用は許容）。
7.  **キャッシュ機構**: `lru_cache` を使用していた箇所は、同等の目的でキャッシュが適切に機能するようにする (例: `get_chroma_client`, `get_langchain_chroma_vectorstore` 内の `gemini_embeddings` インスタンス化など)。 